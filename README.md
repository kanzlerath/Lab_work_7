# Лабораторная работа 7. Преобразование и анализ кода с использованием Clang и LLVM
Цель работы: Познакомиться с инструментами Clang и LLVM, научиться собирать AST и IR-промежуточное представление кода на C/C++, а также извлекать базовую информацию о программе (например, список функций).
Задачи:
1. Установить Clang и LLVM;
2. Скомпилировать простой C-файл с использованием clang и
получить его: абстрактное синтаксическое дерево (AST), промежуточное
представление LLVM IR;
3. Использовать opt для применения базовой комплексной
оптимизации (например, О2);
4. Построить граф потока управления (CFG) для оптимизированной
программы;
5. Проанализировать результат, сделать выводы и ответить на
контрольные вопросы.

## Ход работы

### 1. Установка и подготовка среды

Работа выполнялась в среде **Mac OS Sonoma 14.4**. Установлены следующие инструменты:

- `clang` — компилятор языка C/C++.
- `llvm` — инструменты анализа и оптимизации кода.
- `opt` — инструмент для работы с LLVM IR и применения оптимизаций.
- `Graphviz` — инструмент для визуализации кода.

Команда установки необходимых инструментов через Homebrew:
```bash
brew install llvm graphviz
```

### 2. Исходный код

Пример программы `main.c`:
```c
#include <stdio.h>

int main() {
    int a = 10;
    int b = 20;
    int sum = a + b;
    printf("Sum: %d", sum);
    return 0;
}
```



### 3. Получение AST

Команда для генерации AST:
```bash
clang -Xclang -ast-dump -fsyntax-only main.c
```
![AST](/ast.png)


### 4. Генерация LLVM IR

Команда для генерации LLVM IR:
```bash
clang -S -emit-llvm main.c -o main.ll
```
![LLVM IR](/ir.png)


### 5. Оптимизация IR

Команда для генерации неоптимизированного IR:
```bash
clang -O0 -S -emit-llvm main.c -o main_O0.ll
```

Особенности IR до оптимизации:
- Переменные `a`, `b`, и `sum` (представленные как `%2`, `%3`, `%4` соответственно) явно выделяются в памяти на стеке с использованием инструкции `alloca`. `%1` также выделен для хранения возвращаемого значения `main`.
- Присваивание значений констант (`10`, `20`) и результата сложения (`sum`) выполняется с помощью инструкции `store`. Чтение значений переменных перед сложением и перед вызовом `printf` выполняется с помощью инструкции `load`.
- Функция `printf` вызывается с аргументом, загруженным из памяти.
- Код прямолинеен и соответствует структуре исходного C-кода.
![opt_ir](/opt_ir.png)


Команда для генерации оптимизированного IR с уровнем `-O2`:
```bash
clang -O2 -S -emit-llvm main.c -o main_O2.ll
```

Особенности IR после оптимизации:
- В оптимизированном коде полностью отсутствуют инструкции alloca, load и store для переменных a, b, и sum.
- Компилятор определил, что `a` и `b` являются константами, и вычислил их сумму (`10 + 20 = 30`) на этапе компиляции. Сами переменные и операции над ними стали излишними.
- Инструкции, связанные с выделением памяти и манипуляциями с переменными `a`, `b`, `sum`, были определены как "мертвый" код после выполнения свертывания констант и были удалены.
- Результат сложения (константа `30`) напрямую передается в функцию `printf` в качестве аргумента.
![opt_ir_2](opt_ir_2.png)


Команда для сравнения IR до и после оптимизации:
```bash
diff main_O0.ll main_O2.ll
```
![image](/comparison.png)


Изменения после оптимизации:
- Удалены alloca (Переменные, размещавшиеся в памяти, устранены)
- Устранены load/store и промежуточные вычисления (Операции доступа к памяти и промежуточные сложения удалены)
- Константы вычислены на этапе компиляции (Результат сложения (30) вычислен заранее)
- Прямая передача константы в printf


### 6. Граф потока управления программы

Команда для генерации `.dot`-файлов CFG:
```bash
opt -passes=dot-cfg -disable-output main_O2.ll
```
![dot](/cr_dot.png)

Создается DOT-файл:
- `.main.dot` — для функции `main`.

Команда для преобразования `.dot` в `.png`:
```bash
dot -Tpng .main.dot -o cfg_main.png
```

![cfg_main](/cfg.png)



## Выводы

- С помощью Clang можно получить полную структуру AST, IR и CFG.
- LLVM предоставляет гибкие инструменты анализа и оптимизации.
- Промежуточное представление (IR) удобно для написания компиляторных трансформаций.
